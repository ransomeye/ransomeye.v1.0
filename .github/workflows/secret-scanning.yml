name: Secret Scanning - PHASE 9

# PHASE-9: Automated secret scanning in CI
# Fails build if hardcoded credentials detected

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning
      
      - name: Run secret scanning
        run: |
          echo "Scanning for hardcoded credentials..."
          
          # Patterns to detect credentials
          PATTERNS=(
            "password.*=.*['\"][^'\"]{4,}['\"]"
            "PASSWORD.*=.*['\"][^'\"]{4,}['\"]"
            "secret.*=.*['\"][^'\"]{4,}['\"]"
            "SECRET.*=.*['\"][^'\"]{4,}['\"]"
            "token.*=.*['\"][^'\"]{4,}['\"]"
            "TOKEN.*=.*['\"][^'\"]{4,}['\"]"
            "api_key.*=.*['\"][^'\"]{4,}['\"]"
            "API_KEY.*=.*['\"][^'\"]{4,}['\"]"
            "['\"]gagan['\"]"
            "['\"]test_password.*['\"]"
            "['\"]test_signing_key.*['\"]"
            "['\"]changeme['\"]"
            "['\"]password['\"]"
            "['\"]12345678['\"]"
          )
          
          FAILED=0
          
          # Scan all files (excluding .git, build, node_modules)
          while IFS= read -r file; do
            # Skip binary files and common non-code directories
            if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|pdf|zip|tar|gz|exe|dll|so|bin)$ ]] || \
               [[ "$file" =~ ^(\.git|build|node_modules|\.venv|venv|dist|target)/ ]]; then
              continue
            fi
            
            # Check each pattern
            for pattern in "${PATTERNS[@]}"; do
              # Exclude comments and documentation patterns
              if grep -E "^[^#]*${pattern}" "$file" > /dev/null 2>&1; then
                # Double-check it's executable code, not just documentation
                if [[ "$file" =~ \.(py|sh|bash|yml|yaml|json|js|ts|rs|go|java|cpp|c)$ ]] || \
                   [[ "$file" =~ ^\.github/workflows/ ]] || \
                   [[ "$file" =~ ^installer/.*\.(sh|bat)$ ]]; then
                  echo "❌ BLOCKED: Potential hardcoded credential found in $file"
                  echo "   Pattern: $pattern"
                  grep -n -E "^[^#]*${pattern}" "$file" | head -3 | sed 's/^/   /'
                  FAILED=1
                fi
              fi
            done
          done < <(find . -type f -not -path './.git/*' -not -path './build/*' -not -path './node_modules/*')
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "❌ ERROR: Build blocked due to hardcoded credentials"
            echo ""
            echo "Remediation:"
            echo "  1. Remove hardcoded credentials from code"
            echo "  2. Use environment variables or GitHub Secrets"
            echo "  3. For test credentials, use GitHub Secrets"
            echo ""
            exit 1
          fi
          
          echo "✅ Secret scanning passed - no hardcoded credentials detected"
        # PHASE-9: Fail-closed - secrets must not be in code
        continue-on-error: false

name: CI Validation - PHASE 6 (Reusable)

# PHASE 6 LOCKED
# GA gating, validation execution, signing, and SBOM verification are FINAL.
# Any modification requires Phase-6 re-certification.

# PURE REUSABLE WORKFLOW
# This workflow contains ONLY workflow_call trigger and validation logic.
# It is called by:
#   - ci-validation.yml (wrapper for push/PR triggers)
#   - ci-build-and-sign.yml (for GA gating)

on:
  workflow_call:
    outputs:
      ga_verdict:
        description: "Final GA verdict"
        value: ${{ jobs.aggregate-ga-verdict.outputs.ga_verdict }}
      ga_ready:
        description: "GA readiness flag"
        value: ${{ jobs.aggregate-ga-verdict.outputs.ga_ready }}

permissions:
  contents: read
  actions: read

# PHASE 6: CI Fail-Closed Enforcement
# This workflow blocks CI on any failed validation phase (01-40)
# Treats warnings as failures for security phases
# Prevents merge if CI is red

env:
  PYTHON_VERSION: '3.10'
  POSTGRES_VERSION: '14'
  RANSOMEYE_DB_NAME: 'ransomeye_test'
  RANSOMEYE_DB_USER: 'ransomeye_test'
  RANSOMEYE_DB_PASSWORD: 'test_password_change_in_production'
  RANSOMEYE_DB_HOST: 'localhost'
  RANSOMEYE_DB_PORT: '5432'
  # PHASE 6: Deterministic test harness - no network access unless explicitly enabled
  RANSOMEYE_TEST_NETWORK_ENABLED: 'false'
  RANSOMEYE_TEST_DETERMINISTIC: 'true'
  RANSOMEYE_TEST_SEED: '42'  # Fixed seed for deterministic tests

jobs:
  # PHASE 6: License Compliance Gate
  license-compliance:
    name: License Compliance Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Run license compliance check
        run: |
          cd validation/license_compliance
          ./ci_license_gate.sh
        # PHASE 6: Fail-closed - any license violation blocks build
        continue-on-error: false

  # PHASE 6: Validation Phase C-L (Linux)
  validation-phase-c-linux:
    name: Validation Phase C-L (Linux)
    runs-on: ubuntu-latest
    needs: license-compliance
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_DB: ${{ env.RANSOMEYE_DB_NAME }}
          POSTGRES_USER: ${{ env.RANSOMEYE_DB_USER }}
          POSTGRES_PASSWORD: ${{ env.RANSOMEYE_DB_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client libpq-dev
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install psycopg2-binary
          # Install project dependencies
          find . -name "requirements.txt" -exec pip install -r {} \;
      
      - name: Run Phase C-L validation
        env:
          RANSOMEYE_DB_NAME: ${{ env.RANSOMEYE_DB_NAME }}
          RANSOMEYE_DB_USER: ${{ env.RANSOMEYE_DB_USER }}
          RANSOMEYE_DB_PASSWORD: ${{ env.RANSOMEYE_DB_PASSWORD }}
          RANSOMEYE_DB_HOST: localhost
          RANSOMEYE_DB_PORT: 5432
          RANSOMEYE_TEST_NETWORK_ENABLED: ${{ env.RANSOMEYE_TEST_NETWORK_ENABLED }}
          RANSOMEYE_TEST_DETERMINISTIC: ${{ env.RANSOMEYE_TEST_DETERMINISTIC }}
          RANSOMEYE_TEST_SEED: ${{ env.RANSOMEYE_TEST_SEED }}
        run: |
          cd validation/harness
          python3 phase_c_executor.py --mode linux --output-dir ../../validation/reports/phase_c
        # PHASE 6: Fail-closed - any validation failure blocks build
        continue-on-error: false
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-c-linux-results
          path: validation/reports/phase_c/phase_c_linux_results.json
          retention-days: 30

  # PHASE 6: Validation Phase C-W (Windows)
  validation-phase-c-windows:
    name: Validation Phase C-W (Windows)
    runs-on: windows-latest
    needs: license-compliance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary
          # Install project dependencies
          Get-ChildItem -Recurse -Filter "requirements.txt" | ForEach-Object { pip install -r $_.FullName }
      
      - name: Configure deterministic test harness
        shell: pwsh
        run: |
          bash ci/deterministic_test_harness.sh
        # PHASE 6: Fail-closed - deterministic test harness must be configured
        continue-on-error: false
      
      - name: Run Phase C-W validation
        env:
          RANSOMEYE_TEST_NETWORK_ENABLED: ${{ env.RANSOMEYE_TEST_NETWORK_ENABLED }}
          RANSOMEYE_TEST_DETERMINISTIC: ${{ env.RANSOMEYE_TEST_DETERMINISTIC }}
          RANSOMEYE_TEST_SEED: ${{ env.RANSOMEYE_TEST_SEED }}
        working-directory: validation/harness
        run: |
          python phase_c_executor.py --mode windows --output-dir ..\..\validation\reports\phase_c
        # PHASE 6: Fail-closed - any validation failure blocks build
        continue-on-error: false
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-c-windows-results
          path: validation/reports/phase_c/phase_c_windows_results.json
          retention-days: 30

  # PHASE 6: Aggregate GA Verdict
  aggregate-ga-verdict:
    name: Aggregate GA Verdict
    runs-on: ubuntu-latest
    needs: [validation-phase-c-linux, validation-phase-c-windows]
    outputs:
      ga_verdict:
        description: "Final GA verdict"
        value: ${{ steps.set-outputs.outputs.ga_verdict }}
      ga_ready:
        description: "GA readiness flag"
        value: ${{ steps.set-outputs.outputs.ga_ready }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Download Linux results
        uses: actions/download-artifact@v4
        with:
          name: phase-c-linux-results
          path: validation/reports/phase_c
      
      - name: Download Windows results
        uses: actions/download-artifact@v4
        with:
          name: phase-c-windows-results
          path: validation/reports/phase_c
      
      - name: Aggregate GA verdict
        working-directory: validation/harness
        run: |
          python3 aggregate_ga_verdict.py \
            ../../validation/reports/phase_c/phase_c_linux_results.json \
            ../../validation/reports/phase_c/phase_c_windows_results.json
        # PHASE 6: Fail-closed - GA verdict must be PASS (aggregate_ga_verdict.py exits with 1 on FAIL)
        continue-on-error: false
      
      - name: Check GA verdict
        id: set-outputs
        run: |
          cd validation/reports/phase_c
          if [ ! -f "phase_c_aggregate_verdict.json" ]; then
            echo "❌ GA verdict file not found"
            exit 1
          fi
          VERDICT=$(python3 -c "import json; print(json.load(open('phase_c_aggregate_verdict.json'))['verdict'])")
          GA_READY=$(python3 -c "import json; print(json.load(open('phase_c_aggregate_verdict.json'))['ga_ready'])")
          # Set outputs for workflow and job
          echo "ga_verdict=$VERDICT" >> $GITHUB_OUTPUT
          echo "ga_ready=$GA_READY" >> $GITHUB_OUTPUT
          # PHASE 6: Fail-closed validation - GA verdict must be GA-READY and ga_ready must be True
          if [ "$GA_READY" != "True" ] || [ "$VERDICT" != "GA-READY" ]; then
            echo "❌ GA Verdict: $VERDICT (ga_ready: $GA_READY)"
            echo "Build blocked: GA verdict must be GA-READY and ga_ready must be True"
            exit 1
          fi
          echo "✅ GA Verdict: $VERDICT (ga_ready: $GA_READY)"
        # PHASE 6: Fail-closed - GA verdict must be GA-READY
        continue-on-error: false
      
      - name: Upload GA verdict
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ga-verdict
          path: validation/reports/phase_c/phase_c_aggregate_verdict.json
          retention-days: 90

{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ransomeye.v1.0/installer/env-contract",
  "title": "RansomEye v1.0 Environment Variable Contract",
  "description": "AUTHORITATIVE: Machine-readable environment variable contract. All services MUST read paths from environment variables. No service may compute paths internally.",
  "type": "object",
  "required": [
    "version",
    "required_variables",
    "validation_rules",
    "component_specific_variables"
  ],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Contract version. MUST match installer bundle version."
    },
    "required_variables": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "name",
          "type",
          "required",
          "description",
          "source",
          "validation_pattern",
          "example"
        ],
        "additionalProperties": false,
        "properties": {
          "name": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": ["path", "string", "integer", "uuid", "hash", "version", "enum"]
          },
          "required": {
            "type": "boolean"
          },
          "description": {
            "type": "string"
          },
          "source": {
            "type": "string"
          },
          "validation_pattern": {
            "type": "string"
          },
          "example": {
            "type": "string"
          }
        }
      },
      "default": [
        {
          "name": "RANSOMEYE_INSTALL_ROOT",
          "type": "path",
          "required": true,
          "description": "Absolute path to installation root directory",
          "source": "install.manifest.json → install_root",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye"
        },
        {
          "name": "RANSOMEYE_BIN_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to binary directory",
          "source": "install.manifest.json → directories.bin",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/bin"
        },
        {
          "name": "RANSOMEYE_LIB_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to library directory",
          "source": "install.manifest.json → directories.lib",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/lib"
        },
        {
          "name": "RANSOMEYE_ETC_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to configuration directory",
          "source": "install.manifest.json → directories.etc",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/etc"
        },
        {
          "name": "RANSOMEYE_DATA_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to data directory",
          "source": "install.manifest.json → directories.data",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/data"
        },
        {
          "name": "RANSOMEYE_LOG_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to log directory",
          "source": "install.manifest.json → directories.log",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/log"
        },
        {
          "name": "RANSOMEYE_RUN_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to runtime directory",
          "source": "install.manifest.json → directories.run",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/run"
        },
        {
          "name": "RANSOMEYE_TMP_DIR",
          "type": "path",
          "required": true,
          "description": "Absolute path to temporary directory",
          "source": "install.manifest.json → directories.tmp",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/tmp"
        },
        {
          "name": "RANSOMEYE_USER",
          "type": "string",
          "required": true,
          "description": "System username for RansomEye runtime",
          "source": "install.manifest.json → runtime_identity.user",
          "validation_pattern": "^[a-z_][a-z0-9_]*$",
          "example": "ransomeye"
        },
        {
          "name": "RANSOMEYE_GROUP",
          "type": "string",
          "required": true,
          "description": "System groupname for RansomEye runtime",
          "source": "install.manifest.json → runtime_identity.group",
          "validation_pattern": "^[a-z_][a-z0-9_]*$",
          "example": "ransomeye"
        },
        {
          "name": "RANSOMEYE_UID",
          "type": "integer",
          "required": true,
          "description": "Numeric user ID (UID) for RansomEye runtime",
          "source": "install.manifest.json → runtime_identity.uid",
          "validation_pattern": "^[1-9][0-9]{0,3}$|^[1-5][0-9]{4}$|^6553[0-4]$",
          "example": "1000"
        },
        {
          "name": "RANSOMEYE_GID",
          "type": "integer",
          "required": true,
          "description": "Numeric group ID (GID) for RansomEye runtime",
          "source": "install.manifest.json → runtime_identity.gid",
          "validation_pattern": "^[1-9][0-9]{0,3}$|^[1-5][0-9]{4}$|^6553[0-4]$",
          "example": "1000"
        },
        {
          "name": "RANSOMEYE_COMPONENT",
          "type": "enum",
          "required": true,
          "description": "Component identifier for this service instance",
          "source": "Determined by service startup",
          "validation_pattern": "^(linux_agent|windows_agent|dpi|core|correlation_engine|ai_core)$",
          "example": "core"
        },
        {
          "name": "RANSOMEYE_COMPONENT_INSTANCE_ID",
          "type": "uuid",
          "required": true,
          "description": "Unique identifier for this specific component instance",
          "source": "Generated by installer or service startup script",
          "validation_pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
          "example": "550e8400-e29b-41d4-a716-446655440000"
        },
        {
          "name": "RANSOMEYE_VERSION",
          "type": "version",
          "required": true,
          "description": "RansomEye version string",
          "source": "Hardcoded in installer or service binary",
          "validation_pattern": "^1\\.0\\.0$",
          "example": "1.0.0"
        },
        {
          "name": "RANSOMEYE_CONTRACT_BUNDLE_HASH",
          "type": "hash",
          "required": true,
          "description": "SHA256 hash of Phase 1 contract bundle",
          "source": "install.manifest.json → bundle_hashes.contract_bundle_sha256",
          "validation_pattern": "^[a-fA-F0-9]{64}$",
          "example": "abc123def456..."
        },
        {
          "name": "RANSOMEYE_SCHEMA_BUNDLE_HASH",
          "type": "hash",
          "required": true,
          "description": "SHA256 hash of Phase 2 schema bundle",
          "source": "install.manifest.json → bundle_hashes.schema_bundle_sha256",
          "validation_pattern": "^[a-fA-F0-9]{64}$",
          "example": "def456abc123..."
        },
        {
          "name": "RANSOMEYE_MANIFEST_PATH",
          "type": "path",
          "required": true,
          "description": "Absolute path to installation manifest file",
          "source": "Computed by installer: ${RANSOMEYE_ETC_DIR}/install.manifest.json",
          "validation_pattern": "^/.*[^/]$",
          "example": "/opt/ransomeye/etc/install.manifest.json"
        }
      ]
    },
    "validation_rules": {
      "type": "object",
      "required": [
        "required_check",
        "path_validation",
        "path_permissions",
        "type_validation"
      ],
      "properties": {
        "required_check": {
          "type": "object",
          "required": ["action", "failure_mode"],
          "properties": {
            "action": {
              "type": "string",
              "const": "REJECT_STARTUP",
              "description": "Missing required variables MUST cause startup failure"
            },
            "failure_mode": {
              "type": "string",
              "const": "FAIL_CLOSED",
              "description": "Fail-closed: do not start service with missing variables"
            }
          }
        },
        "path_validation": {
          "type": "object",
          "required": ["must_be_absolute", "must_not_end_with_slash", "action_on_relative"],
          "properties": {
            "must_be_absolute": {
              "type": "boolean",
              "const": true,
              "description": "All path variables MUST be absolute paths (starting with /)"
            },
            "must_not_end_with_slash": {
              "type": "boolean",
              "const": true,
              "description": "All path variables MUST NOT end with trailing slash"
            },
            "action_on_relative": {
              "type": "string",
              "const": "REJECT_STARTUP",
              "description": "Relative paths MUST cause startup failure"
            }
          }
        },
        "path_permissions": {
          "type": "object",
          "required": ["check_read", "check_write", "action_on_insufficient"],
          "properties": {
            "check_read": {
              "type": "boolean",
              "const": true,
              "description": "Services MUST check read permissions on required directories"
            },
            "check_write": {
              "type": "boolean",
              "const": true,
              "description": "Services MUST check write permissions on required directories"
            },
            "action_on_insufficient": {
              "type": "string",
              "const": "REJECT_STARTUP",
              "description": "Insufficient permissions MUST cause startup failure"
            }
          }
        },
        "type_validation": {
          "type": "object",
          "required": ["uid_gid_integer", "component_enum", "version_format"],
          "properties": {
            "uid_gid_integer": {
              "type": "boolean",
              "const": true,
              "description": "UID/GID MUST be valid integers"
            },
            "component_enum": {
              "type": "boolean",
              "const": true,
              "description": "Component enum MUST match allowed values"
            },
            "version_format": {
              "type": "boolean",
              "const": true,
              "description": "Version MUST match expected format"
            }
          }
        }
      }
    },
    "component_specific_variables": {
      "type": "object",
      "required": [
        "core",
        "linux_agent",
        "windows_agent",
        "dpi",
        "correlation_engine",
        "ai_core"
      ],
      "properties": {
        "core": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=core",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)"
          ]
        },
        "linux_agent": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=linux_agent",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)",
            "RANSOMEYE_MACHINE_ID (REQUIRED, machine identifier)"
          ]
        },
        "windows_agent": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=windows_agent",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)",
            "RANSOMEYE_MACHINE_ID (REQUIRED, machine identifier)"
          ]
        },
        "dpi": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=dpi",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)"
          ]
        },
        "correlation_engine": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=correlation_engine",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)"
          ]
        },
        "ai_core": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "RANSOMEYE_COMPONENT=ai_core",
            "RANSOMEYE_COMPONENT_INSTANCE_ID (REQUIRED, unique UUID)"
          ]
        }
      }
    },
    "prohibited_patterns": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "default": [
        "Compute paths relative to executable location",
        "Use argv[0] or __file__ to determine paths",
        "Assume standard locations (/opt, /usr/local, /var, etc.)",
        "Use hardcoded paths anywhere in service code",
        "Read paths from configuration files (paths come from environment only)",
        "Use relative paths (all paths MUST be absolute)"
      ]
    }
  }
}

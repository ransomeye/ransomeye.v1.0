#!/usr/bin/env python3
"""
RansomEye HNMP Engine - Malware Normalizer
AUTHORITATIVE: Canonical malware event normalization
"""

from typing import Dict, Any
from datetime import datetime, timezone
import uuid
import hashlib
import json


class MalwareNormalizationError(Exception):
    """Base exception for malware normalization errors."""
    pass


class MalwareNormalizer:
    """
    Canonical malware event normalizer.
    
    Properties:
    - Deterministic: Same input = same normalized output
    - Canonical: Normalized events are canonical
    - Facts only: No inference, no scoring
    """
    
    def __init__(self):
        """Initialize malware normalizer."""
        pass
    
    def normalize(
        self,
        raw_event: Dict[str, Any],
        source_agent: str
    ) -> Dict[str, Any]:
        """
        Normalize malware event to canonical form.
        
        Args:
            raw_event: Raw malware event from agent
            source_agent: Source agent identifier
        
        Returns:
            Normalized malware event dictionary
        """
        # Extract and validate required fields
        event_type = raw_event.get('event_type', '')
        artifact_id = raw_event.get('artifact_id', '')
        file_hash_sha256 = raw_event.get('file_hash_sha256', '')
        file_hash_sha1 = raw_event.get('file_hash_sha1', '')
        file_hash_md5 = raw_event.get('file_hash_md5', '')
        file_path = raw_event.get('file_path', '')
        timestamp = raw_event.get('timestamp', '')
        event_data = raw_event.get('event_data', {})
        
        # Validate event type
        valid_types = [
            'hash_observation', 'execution_attempt', 'artifact_discovery',
            'sandbox_verdict_reference'
        ]
        if event_type not in valid_types:
            raise MalwareNormalizationError(f"Invalid event type: {event_type}")
        
        # Normalize timestamp (canonical RFC3339 UTC)
        if isinstance(timestamp, str):
            try:
                dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
                if dt.tzinfo is None:
                    dt = dt.replace(tzinfo=timezone.utc)
                normalized_timestamp = dt.isoformat()
            except Exception:
                normalized_timestamp = datetime.now(timezone.utc).isoformat()
        else:
            normalized_timestamp = datetime.now(timezone.utc).isoformat()
        
        # Create normalized event
        normalized = {
            'event_id': str(uuid.uuid4()),
            'event_type': event_type,
            'artifact_id': artifact_id if artifact_id else str(uuid.uuid4()),
            'file_hash_sha256': file_hash_sha256.lower() if file_hash_sha256 else '',
            'file_hash_sha1': file_hash_sha1.lower() if file_hash_sha1 else '',
            'file_hash_md5': file_hash_md5.lower() if file_hash_md5 else '',
            'file_path': file_path,
            'timestamp': normalized_timestamp,
            'event_data': event_data,
            'source_agent': source_agent,
            'immutable_hash': '',
            'ledger_entry_id': ''
        }
        
        # Calculate hash
        normalized['immutable_hash'] = self._calculate_hash(normalized)
        
        return normalized
    
    def _calculate_hash(self, event: Dict[str, Any]) -> str:
        """Calculate SHA256 hash of event record."""
        hashable_content = {k: v for k, v in event.items() if k not in ['immutable_hash', 'ledger_entry_id']}
        canonical_json = json.dumps(hashable_content, sort_keys=True, separators=(',', ':'), ensure_ascii=False)
        content_bytes = canonical_json.encode('utf-8')
        hash_obj = hashlib.sha256(content_bytes)
        return hash_obj.hexdigest()

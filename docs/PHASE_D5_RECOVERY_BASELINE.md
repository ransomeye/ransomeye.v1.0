# PHASE D.5 — RECOVERY BASELINE DEFINITION

**Status**: COMPLETE  
**Date**: 2026-01-18  
**Purpose**: Define minimum Recovery Baseline for RansomEye Core v1.0

---

## D.5.1 — REQUIRED Runtime Artifacts

### Runtime-Critical Artifacts (MUST exist for Core to start)

#### 1. Systemd Service Unit (REQUIRED)
- **File**: `/etc/systemd/system/ransomeye-core.service`
- **Type**: systemd unit file (service)
- **Reconstructable**: YES (from installer template)
- **Source**: Installer generates from `installer/core/ransomeye-core.service` template
- **Criticality**: RUNTIME-CRITICAL
- **Note**: Installer creates ONE unified service (not multiple services). Service is WantedBy=multi-user.target (not a custom target).

#### 2. Installation Directory Structure (REQUIRED)
- **Path**: `/opt/ransomeye/` (or user-specified INSTALL_ROOT)
- **Subdirectories**:
  - `bin/` - Executable wrappers
  - `lib/` - Python code (common, core, services)
  - `config/` - Configuration files
    - `environment` - REQUIRED environment variables
    - `schemas/` - Database schema migrations
    - `contracts/` - Event contracts
  - `logs/` - Log files (writable by ransomeye user)
  - `runtime/` - Runtime state (writable by ransomeye user)
- **Ownership**: `ransomeye:ransomeye`
- **Reconstructable**: NO (contains runtime state, configuration, database migrations)
- **Criticality**: RUNTIME-CRITICAL

#### 3. Environment Configuration File (REQUIRED)
- **File**: `/opt/ransomeye/config/environment`
- **Type**: Shell environment file
- **Contains**: All required environment variables:
  - Installation paths (INSTALL_ROOT, BIN_DIR, LIB_DIR, etc.)
  - Database credentials (DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
  - Component identity (COMPONENT_INSTANCE_ID)
  - Command signing key (COMMAND_SIGNING_KEY)
  - Service ports (INGEST_PORT, UI_PORT)
- **Reconstructable**: NO (contains secrets, instance-specific IDs)
- **Criticality**: RUNTIME-CRITICAL
- **Note**: Generated by installer with prompts. Cannot be regenerated from backup without installer.

#### 4. System User and Group (REQUIRED)
- **User**: `ransomeye`
- **Group**: `ransomeye`
- **Type**: System account (no home directory, shell /bin/false)
- **Reconstructable**: YES (can be created via `useradd --system --no-create-home`)
- **Criticality**: RUNTIME-CRITICAL
- **UID/GID**: May differ between systems (handled via environment file)

#### 5. Executable Wrapper Script (REQUIRED)
- **File**: `/opt/ransomeye/bin/ransomeye-core`
- **Type**: Shell script (executable)
- **Reconstructable**: YES (from installer template, contains only INSTALL_ROOT variable)
- **Criticality**: RUNTIME-CRITICAL

#### 6. PostgreSQL Database (REQUIRED)
- **Database**: `ransomeye` (or user-specified DB_NAME)
- **Schema**: Applied via migrations from `config/schemas/migrations/`
- **Reconstructable**: YES (from backup dump)
- **Criticality**: RUNTIME-CRITICAL

### Deployment-Generated Artifacts (created during installation)

#### 1. Installation Manifest (RECOMMENDED but not runtime-critical)
- **File**: `/opt/ransomeye/config/installer.manifest.json`
- **Type**: JSON metadata
- **Reconstructable**: YES (metadata only)
- **Criticality**: NON-CRITICAL (useful for troubleshooting)

#### 2. Transaction State (Temporary, cleaned after install)
- **File**: `/opt/ransomeye/.install_state.json`
- **Type**: Transaction log
- **Reconstructable**: N/A (removed after successful install)
- **Criticality**: NON-CRITICAL

### Reconstructable vs Non-Reconstructable Classification

#### RECONSTRUCTABLE (can be regenerated):
- Systemd service unit (`ransomeye-core.service`) - from installer template
- Executable wrapper script - from installer template
- System user/group - via standard commands
- Installation directory structure (empty directories) - via mkdir
- Python code (`lib/` directory) - from release bundle
- Schema migrations (`config/schemas/`) - from release bundle

#### NON-RECONSTRUCTABLE (must be in backup):
- Environment configuration file (`config/environment`) - contains secrets and instance-specific IDs
- Database content (user data) - must restore from dump
- Logs directory contents - runtime artifacts
- Runtime directory contents - state files (core_status.json, etc.)

---

## D.5.2 — Recovery Strategy Decision

### Chosen Strategy: **OPTION A — Backup Includes Runtime Units**

### Justification:

1. **Simplicity**: Backup already captures `/etc/systemd/system/ransomeye*` files (phase_d_backup.sh lines 76-85). No change to backup scope needed.

2. **No Installer Dependency**: Restore can complete without installer. Restore script just copies files from backup to `/etc/systemd/system/`.

3. **Fail-Closed Preserved**: Service unit files are immutable configuration (not runtime state). Including them in backup is safe and maintains security guarantees.

4. **Alignment with Current Design**: The installer creates ONE service (`ransomeye-core.service`). Backup/restore should handle this explicitly, not rely on installer replay.

5. **Recovery Time**: Restore is immediate (file copy), no installer execution required.

### Explicit Contract:

- **Backup guarantees**: All files in `/etc/systemd/system/ransomeye*` are included in backup
- **Restore guarantees**: All backed-up systemd units are restored to `/etc/systemd/system/`
- **Runtime requirement**: `ransomeye-core.service` must exist and be valid for Core to start
- **No installer assumption**: Restore does NOT require installer to regenerate units

### Alternatives Considered and Rejected:

**OPTION B — Restore Requires Installer Replay**: 
- REJECTED: Adds installer dependency to recovery, violates "no assumptions about CI/GitHub" requirement
- Installer requires prompts (credentials), not suitable for automated restore

**OPTION C — Hybrid (Minimal Immutable Units)**:
- REJECTED: Adds complexity. Systemd service files are already immutable configuration. Backup scope is simpler.

---

## D.5.3 — Recovery Contract

### RECOVERY CONTRACT v1.0

**Effective Date**: 2026-01-18  
**Applies To**: RansomEye Core v1.0

#### What Backup Alone Guarantees:

1. **Installation Directory**: Complete `/opt/ransomeye/` tree including:
   - All Python code (`lib/`)
   - Configuration files (`config/`, including `environment` with secrets)
   - Log files (`logs/`)
   - Runtime state (`runtime/`)

2. **Systemd Units**: All files matching `/etc/systemd/system/ransomeye*` including:
   - Service unit files (`.service`)
   - Target unit files (`.target`) if present

3. **Database**: Complete logical dump of PostgreSQL database `ransomeye`

4. **System State Snapshot**: Service status, user/group info (metadata only)

**BACKUP DOES NOT GUARANTEE**: System users/groups (can be recreated), PostgreSQL installation (prerequisite)

#### Orchestration Model Requirements (v1.0.1):

**Authoritative Model**: Unified Single-Service Core (Orchestrator Mode)

- **Backup MUST contain**: `ransomeye-core.service` only (no individual component services)
- **Backup MUST NOT contain**: `RANSOMEYE_ORCHESTRATOR=systemd` in environment file (or must be validated against existing services)
- **Restore MUST ensure**: Only `ransomeye-core.service` exists after restore (no individual component services)
- **Restore MUST abort if**: `RANSOMEYE_ORCHESTRATOR=systemd` is set but individual component services are missing
- **Runtime MUST enforce**: Core refuses to start if orchestration mode mismatch detected

**Unsupported Model**: systemd-Managed Multi-Service Core (incompatible with installer design for v1.0)

#### What Restore Alone Guarantees:

1. **Files Restored**: All backed-up files are copied to their original locations
2. **Ownership Set**: `/opt/ransomeye/` owned by `ransomeye:ransomeye` (if user exists)
3. **Systemd Reloaded**: `systemctl daemon-reload` executed after unit restore
4. **Database Restored**: PostgreSQL dump restored (if database does not exist)

**RESTORE DOES NOT GUARANTEE**: System users/groups created (may need manual creation), PostgreSQL running (prerequisite)

#### What Constitutes a Recoverable System:

A system is **RECOVERABLE** if:
1. Backup contains `/opt/ransomeye/` directory with `config/environment` file
2. Backup contains at least one systemd unit file (`ransomeye-core.service` or other ransomeye* units)
3. Backup contains database dump (`.sql` file)

A system is **NOT RECOVERABLE** if:
1. `config/environment` is missing (contains required secrets)
2. No systemd unit files in backup
3. Database dump is missing AND database schema migrations are not available

#### Additional Steps Required:

1. **System User Creation** (if not exists):
   ```bash
   sudo useradd --system --no-create-home --shell /bin/false ransomeye
   ```

2. **PostgreSQL Prerequisites** (if not met):
   - PostgreSQL must be installed and running
   - `postgres` user must exist (system default)

3. **Post-Restore Verification**:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl start ransomeye-core  # Note: service name, not target
   sudo systemctl status ransomeye-core
   ```

#### Explicit Failures (What Causes Restore to Fail):

1. **Missing Environment File**: Restore continues, but Core cannot start (missing secrets)
2. **Missing Systemd Units**: Restore continues, but verification fails (line 207 of restore script)
3. **Database Restore Failure**: Restore continues, but Core cannot connect to database
4. **Ownership Failure**: Restore continues, but Core may fail with permission errors

**Fail-closed behavior**: Restore script exits with error if verification fails (missing `/opt/ransomeye` or missing systemd units).

---

## D.5.4 — Remediation Implementation

### Issues Identified:

1. **Restore script expects wrong unit**: Line 207 checks for `ransomeye-core.target` but installer creates `ransomeye-core.service`
2. **Start command is wrong**: Line 224 suggests starting `ransomeye-core.target` but should be `ransomeye-core.service`

### Fixes Applied:

See `scripts/phase_d_restore.sh` changes below.
